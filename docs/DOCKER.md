## Docker setup – RAG MathTutor backend

This project uses three main services:

* **API**: FastAPI microservice (`mathtuto-api`)
* **Vector store**: Qdrant
* **Lexical search**: Meilisearch

Meilisearch and Qdrant run via `docker-compose` (already in `infra/`).
The FastAPI service runs as a separate Docker container.

The frontend (Next.js) will call the API at:
`http://localhost:8000/explain`

---

### 1. Prerequisites

* Docker and Docker Compose installed (Desktop version is fine on macOS).
* A Google Gemini API key (for LLM explanations).

You should already have:

* `infra/docker-compose.yml` (for Meilisearch + Qdrant).
* `Dockerfile` at the project root (for the API).
* A working `requirements.txt`.

Project layout (simplified):

```text
rag-math-mathtuto/
│
├── src/
│   ├── app.py                 # FastAPI app (entrypoint)
│   ├── retrieval_service.py   # Hybrid retriever (Meili + Qdrant + reranker)
│   ├── llm_service.py         # Gemini LLM wrapper
│   └── ...
│
├── data/
│   └── logic/
│       └── logic_chunks_v1.jsonl   # Precomputed chunks
│
├── infra/
│   └── docker-compose.yml     # Meilisearch + Qdrant
│
├── Dockerfile                 # API image definition
└── requirements.txt
```

---

### 2. Environment variables

The API container needs the following environment variables:

* `GEMINI_API_KEY` – your Gemini key.
* `GEMINI_MODEL` – optional, default is `gemini-2.5-flash` in the code.
* `MEILI_API_KEY` – the same key you use when starting Meilisearch.
* `MEILI_HOST` – inside the container, points to Meilisearch.
* `QDRANT_URL` – inside the container, points to Qdrant.

In the current Dockerfile, `MEILI_HOST` and `QDRANT_URL` defaults are:

```text
MEILI_HOST="http://host.docker.internal:7700"
QDRANT_URL="http://host.docker.internal:6333"
```

On macOS/Windows, `host.docker.internal` is a special hostname that lets a container reach services running on the host machine (where Meili/Qdrant are running).

You can also override these values with `-e` when running the container.

---

### 3. Start Meilisearch and Qdrant (infra)

From the project root:

```bash
cd infra
docker compose up -d
```

This starts:

* Meilisearch on `localhost:7700`
* Qdrant on `localhost:6333`

Verify:

```bash
docker compose ps
```

You should see containers `meilisearch` and `qdrant` running.

Return to the project root after that:

```bash
cd ..
```

---

### 4. Build the API Docker image

At the project root (`rag-math-mathtuto/`):

```bash
docker build -t mathtuto-api .
```

This:

* Uses `python:3.11-slim` as a base.
* Installs packages from `requirements.txt`.
* Copies the project code into `/app` in the image.
* Configures the container to run:

  ```bash
  uvicorn src.app:app --host 0.0.0.0 --port 8000
  ```

---

### 5. Run the API container

Make sure Meilisearch and Qdrant are already running (`docker compose up -d` in `infra/`).

From the project root:

```bash
docker run \
  --rm \
  -p 8000:8000 \
  -e GEMINI_API_KEY="YOUR_REAL_GEMINI_KEY" \
  -e GEMINI_MODEL="gemini-2.5-flash" \
  -e MEILI_API_KEY="CHANGE_ME_STRONG_KEY" \
  mathtuto-api
```

Notes:

* `--rm` deletes the container when it stops (keeps things clean).
* `-p 8000:8000` maps the container’s port 8000 to your host’s port 8000.
* You can add overrides for `MEILI_HOST` / `QDRANT_URL` if needed:

  ```bash
  -e MEILI_HOST="http://host.docker.internal:7700" \
  -e QDRANT_URL="http://host.docker.internal:6333" \
  ```

---

### 6. Health check and test

In a separate terminal:

```bash
curl http://127.0.0.1:8000/health
```

Expected:

```json
{"status":"ok"}
```

Then test the main endpoint:

```bash
curl -X POST "http://127.0.0.1:8000/explain" \
  -H "Content-Type: application/json" \
  -d '{
        "question": "C\"est quoi une proposition logique ?",
        "level": "1BAC",
        "track": "SM",
        "max_chunks": 4
      }'
```

You should get a JSON response with:

* `answer` – explanation generated by the LLM, grounded in the course.
* `used_chunks` – list of chunk IDs and metadata used as context.

This confirms:

* The API container is running correctly.
* It can reach Meilisearch and Qdrant via `host.docker.internal`.
* It can reach Gemini via the provided `GEMINI_API_KEY`.

---

### 7. Stopping the stack

To stop the API container:

* Use `Ctrl+C` in the terminal where `docker run mathtuto-api` is running.

To stop Meilisearch + Qdrant:

```bash
cd infra
docker compose down
cd ..
```

---

### 8. Optional: using an `.env` file

Instead of passing secrets on the command line, you can create a `.env` file at the project root:

```env
GEMINI_API_KEY=YOUR_REAL_GEMINI_KEY
GEMINI_MODEL=gemini-2.5-flash
MEILI_API_KEY=CHANGE_ME_STRONG_KEY
MEILI_HOST=http://host.docker.internal:7700
QDRANT_URL=http://host.docker.internal:6333
```

Then run:

```bash
docker run \
  --rm \
  -p 8000:8000 \
  --env-file .env \
  mathtuto-api
```

Make sure `.env` is listed in `.gitignore` so it is not committed to version control.

---

### 9. How the frontend will use this

From a Next.js app (or any client), you will call:

* `GET http://localhost:8000/health` to check the backend.
* `POST http://localhost:8000/explain` with JSON payload:

  ```json
  {
    "question": "…",
    "level": "1BAC",
    "track": "SM",
    "max_chunks": 4
  }
  ```

The backend returns the explanation and the list of course chunks used. This API is the entrypoint you will integrate into your MathTutor SAAS.
